{% extends "base.html" %}

{% block title %}Search Student - CCS Admin{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <i data-feather="search"></i> Search Student
    </div>
    <div class="card-body">
        <form action="{{ url_for('search') }}" method="post" id="student-search-form">
            <div class="form-group">
                <input type="text" id="student-id-input" name="student_id" class="form-control" placeholder="Search...">
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
</div>

{% if student %}
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <i data-feather="user"></i> Student Information
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table">
                    <tr>
                        <th>ID Number:</th>
                        <td>{{ student.id }}</td>
                    </tr>
                    <tr>
                        <th>Name:</th>
                        <td>{{ student.name }}</td>
                    </tr>
                    <tr>
                        <th>Program:</th>
                        <td>{{ student.program }}</td>
                    </tr>
                    <tr>
                        <th>Year Level:</th>
                        <td>{{ student.year_level }}</td>
                    </tr>
                    <tr>
                        <th>Date Registered:</th>
                        <td>{{ student.date_registered }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <div style="text-align: center; margin-bottom: 20px;">
                    <a href="{{ url_for('sit_in') }}?student_id={{ student.id }}" class="btn btn-primary">
                        <i data-feather="log-in"></i> Sit-In This Student
                    </a>
                </div>
                
                <div class="card" style="border: 1px solid #ddd; border-radius: 4px;">
                    <div class="card-header" style="background-color: #f4f7fa;">
                        Recent Activity
                    </div>
                    <div class="card-body">
                        <ul style="padding-left: 20px;">
                            {% set conn = get_db_connection() %}
                            {% set recent_activity = conn.execute('SELECT purpose, lab_id, login_time, logout_time FROM sit_ins WHERE student_id = ? ORDER BY login_time DESC LIMIT 5', (student.id,)).fetchall() %}
                            {% if recent_activity %}
                                {% for activity in recent_activity %}
                                <li>
                                    {{ activity.purpose }} in Lab {{ activity.lab_id }} on 
                                    {{ activity.login_time.split()[0] }}
                                    ({{ activity.login_time.split()[1][:5] }} - 
                                    {% if activity.logout_time %}
                                        {{ activity.logout_time.split()[1][:5] }})
                                    {% else %}
                                        Active)
                                    {% endif %}
                                </li>
                                {% endfor %}
                            {% else %}
                                <li>No recent activity</li>
                            {% endif %}
                            {% if conn %}{% do conn.close() %}{% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sit-In Modal -->
<div id="sit-in-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Sit-In Form</h3>
        <form action="{{ url_for('sit_in') }}" method="post">
            <div class="form-group">
                <label for="student_id">ID Number:</label>
                <input type="text" id="student_id" name="student_id" class="form-control" value="{{ student.id }}" readonly>
            </div>
            <div class="form-group">
                <label for="student_name">Student Name:</label>
                <input type="text" id="student_name" name="student_name" class="form-control" value="{{ student.name }}" readonly>
            </div>
            <div class="form-group">
                <label for="purpose">Purpose:</label>
                <input type="text" id="purpose" name="purpose" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="lab">Lab:</label>
                <select id="lab" name="lab" class="form-control" required>
                    <option value="">Select Laboratory</option>
                    {% set conn = get_db_connection() %}
                    {% set labs = conn.execute('SELECT * FROM laboratories').fetchall() %}
                    {% for lab in labs %}
                    <option value="{{ lab.id }}">{{ lab.name }}</option>
                    {% endfor %}
                    {% if conn %}{% do conn.close() %}{% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="remaining_session">Remaining Session:</label>
                <input type="number" id="remaining_session" name="remaining_session" class="form-control" value="30" min="1" max="180">
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('sit-in-modal').style.display='none'">Close</button>
                <button type="submit" class="btn btn-primary">Sit In</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Focus search input when page loads
        document.getElementById('student-id-input').focus();
        
        // Trigger sit-in modal button if URL has student_id parameter
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('student_id');
        
        if (studentId) {
            // Populate search input and submit form
            document.getElementById('student-id-input').value = studentId;
            document.getElementById('student-search-form').submit();
        }
    });
</script>
{% endblock %}
